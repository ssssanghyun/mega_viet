# 배포 불일치 근본 원인 분석 보고서

**분석 일시**: 2024년 12월  
**분석 대상**: mega_viet 프로젝트 (로컬 vs Vercel 배포)  
**분석자**: Senior Engineer

---

## 1. Root Cause Summary (가능성 순서)

### 🔴 **1순위: Vercel이 잘못된 Git 저장소를 배포하고 있음 (확정)**

**증거**:
- 로컬 Git remote: `origin → https://github.com/Jeonghyun-pp/mega_thaiver.git`
- 사용자가 언급한 저장소: `https://github.com/ssssanghyun/mega_viet`
- **두 저장소가 다름**: Vercel이 `Jeonghyun-pp/mega_thaiver`를 배포 중일 가능성
- 또는 Vercel이 `ssssanghyun/mega_viet`의 이전 커밋을 배포 중일 수 있음

**영향**: 
- 로컬에서 최신 코드를 작성했지만, Vercel은 다른 저장소의 구버전을 배포
- 코드 변경사항이 배포에 반영되지 않음

### 🟡 **2순위: Root Directory 설정 불일치**

**증거**:
- `vercel.json`에 `"rootDirectory": "web"` 설정됨
- 하지만 Vercel 대시보드에서 Root Directory가 다르게 설정되어 있을 수 있음
- Vercel은 대시보드 설정이 `vercel.json`보다 우선순위가 높을 수 있음

**영향**:
- 빌드가 프로젝트 루트에서 실행되어 `web` 폴더의 코드를 찾지 못함
- 또는 잘못된 디렉토리에서 빌드하여 구버전 코드가 사용됨

### 🟡 **3순위: 빌드 캐시 문제**

**증거**:
- Vercel은 기본적으로 빌드 캐시를 사용
- 이전 빌드의 `.next` 캐시가 재사용될 수 있음
- Git 커밋 해시가 같아도 캐시된 빌드 결과가 사용될 수 있음

**영향**:
- 최신 코드로 빌드해도 이전 빌드 결과가 배포됨

---

## 2. Classification

### ✅ **Confirmed Causes (확정된 원인)**

1. **Git 저장소 불일치**
   - **파일 위치**: `.git/config` 또는 `git remote -v` 출력
   - **코드 증거**: 
     ```bash
     origin  https://github.com/Jeonghyun-pp/mega_thaiver.git
     ```
   - 로컬은 `mega_thaiver` 저장소에 연결, 사용자는 `mega_viet` 저장소를 원함
   - **해결**: Vercel 대시보드에서 연결된 저장소 확인 및 변경

### 🔶 **Highly Probable Causes (높은 확률)**

1. **Root Directory 설정 불일치**
   - **파일 위치**: `web/vercel.json` (line 7)
   - **코드 증거**:
     ```json
     {
       "rootDirectory": "web"
     }
     ```
   - Vercel 대시보드에서 다른 Root Directory가 설정되어 있을 수 있음
   - **해결**: Vercel 대시보드에서 Root Directory를 `web`으로 명시적으로 설정

2. **빌드 캐시로 인한 구버전 배포**
   - **증거**: Vercel의 기본 빌드 캐시 동작
   - **해결**: 캐시 무시하고 재배포

### 🔵 **Low-Probability Causes (낮은 확률)**

1. **환경 변수 차이**
   - **파일 위치**: `web/src/app/api/analyze/route.ts` (line 5, 28)
   - **코드 증거**:
     ```typescript
     const openai = new OpenAI({
       apiKey: process.env.OPENAI_API_KEY,
     });
     ```
   - 로컬 `.env.local`에는 API 키가 있지만, Vercel에 없을 수 있음
   - **영향**: AI 분석 기능만 실패, UI 차이는 없음

2. **브라우저 캐시**
   - 사용자 브라우저가 이전 JavaScript 번들을 캐시
   - **해결**: 하드 리프레시 (Ctrl+Shift+R)

---

## 3. Exact Files and Code Locations

### 문제가 발생할 수 있는 파일 위치

1. **Git 저장소 설정**
   - 위치: `.git/config`
   - 확인 명령: `git remote -v`

2. **Vercel 설정**
   - 위치: `web/vercel.json` (line 7)
   - 내용: `"rootDirectory": "web"`

3. **환경 변수 사용**
   - 위치: `web/src/app/api/analyze/route.ts` (line 5, 28)
   - 사용: `process.env.OPENAI_API_KEY`

4. **정답 필드 구현**
   - 위치: `web/src/components/AnalysisForm.tsx` (line 119-122)
   - 코드:
     ```tsx
     <div className="col-span-3">
       <div className="w-full px-2 py-1.5 bg-gray-100 border border-gray-200 rounded text-sm text-center text-gray-700 font-medium">
         {correctAnswers[questionNum - 1] || '-'}
       </div>
     </div>
     ```
   - **확인**: 이 코드가 배포된 버전에도 있는지 확인 필요

---

## 4. Technical Explanation

### 왜 로컬에서는 작동하는가?

1. **로컬 개발 환경**
   - `npm run dev`는 `web` 디렉토리에서 실행
   - 최신 코드가 즉시 반영됨
   - `.env.local` 파일이 자동으로 로드됨
   - 빌드 캐시가 없거나 무시됨

2. **로컬 빌드**
   - `npm run build`는 현재 디렉토리(`web`)에서 실행
   - 모든 최신 파일이 빌드에 포함됨

### 왜 Vercel에서는 다르게 동작하는가?

1. **Git 저장소 불일치**
   - Vercel이 다른 저장소(`Jeonghyun-pp/mega_thaiver`)를 배포
   - 해당 저장소에는 구버전 코드가 있음
   - 로컬에서 푸시한 최신 코드가 반영되지 않음

2. **Root Directory 문제**
   - Vercel 대시보드에서 Root Directory가 `web`이 아닌 다른 값으로 설정
   - 빌드가 잘못된 디렉토리에서 실행됨
   - `web` 폴더 내의 최신 코드를 찾지 못함

3. **빌드 캐시**
   - Vercel이 이전 빌드의 캐시를 재사용
   - 최신 코드로 빌드해도 이전 빌드 결과가 배포됨

4. **환경 변수**
   - Vercel에 `OPENAI_API_KEY`가 설정되지 않음
   - API 호출 실패 (하지만 UI 차이는 없어야 함)

---

## 5. Fixes

### 🔧 **Minimal Fix (최소 위험, 즉시 적용 가능)**

#### Fix 1: Vercel 저장소 연결 확인 및 변경

**단계**:
1. Vercel 대시보드 접속: https://vercel.com
2. 프로젝트 선택
3. Settings → Git
4. 현재 연결된 Repository 확인
5. **`ssssanghyun/mega_viet`인지 확인**
6. 다르다면:
   - Disconnect 클릭
   - "Connect Git Repository" 클릭
   - `ssssanghyun/mega_viet` 선택
   - Root Directory를 `web`으로 설정
7. "Redeploy" 실행 (캐시 무시 옵션 활성화)

**예상 결과**: 최신 코드가 배포됨

#### Fix 2: Root Directory 명시적 설정

**단계**:
1. Vercel 대시보드 → Settings → General
2. Root Directory 확인
3. `web`으로 설정 (없다면 입력)
4. Save
5. "Redeploy" 실행

**예상 결과**: 올바른 디렉토리에서 빌드됨

#### Fix 3: 빌드 캐시 무시하고 재배포

**단계**:
1. Vercel 대시보드 → Deployments
2. 최신 배포의 "..." 메뉴 클릭
3. "Redeploy" 선택
4. **"Use existing Build Cache" 옵션 해제** (중요!)
5. 배포 완료 대기

**예상 결과**: 최신 코드로 새로 빌드됨

### 🏗️ **Structural Fix (권장, 근본 해결)**

#### Fix 4: vercel.json 강화 및 검증

**현재 `web/vercel.json`**:
```json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "nextjs",
  "regions": ["icn1"],
  "rootDirectory": "web"
}
```

**문제점**: 
- `rootDirectory`가 있지만, Vercel 대시보드 설정이 우선순위가 높을 수 있음
- Git 저장소 정보가 없음

**개선안**:
1. Vercel 대시보드에서 Root Directory를 명시적으로 `web`으로 설정
2. Git 저장소를 `ssssanghyun/mega_viet`로 연결
3. `vercel.json`은 보조 설정으로만 사용

#### Fix 5: 배포 검증 자동화

**추가할 파일**: `.github/workflows/vercel-deploy-check.yml` (선택사항)

```yaml
name: Vercel Deploy Check
on:
  push:
    branches: [main]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Verify build
        run: |
          cd web
          npm install
          npm run build
```

**목적**: 배포 전 빌드 검증

---

## 6. Post-Deployment Verification Checklist

### ✅ **즉시 확인 사항**

- [ ] **Git 저장소 확인**
  - Vercel 대시보드 → Settings → Git
  - Repository가 `ssssanghyun/mega_viet`인지 확인
  - 최신 커밋 해시가 로컬과 일치하는지 확인

- [ ] **Root Directory 확인**
  - Settings → General → Root Directory
  - 값이 `web`인지 확인

- [ ] **환경 변수 확인**
  - Settings → Environment Variables
  - `OPENAI_API_KEY`가 설정되어 있는지 확인
  - Production, Preview, Development 모두에 설정되어 있는지 확인

- [ ] **배포 로그 확인**
  - Deployments → 최신 배포 클릭
  - 빌드 로그에서 "Building in directory: web" 확인
  - 빌드 성공 여부 확인
  - 에러 메시지 확인

### ✅ **기능 테스트**

- [ ] **홈페이지 로드**
  - 배포된 URL 접속
  - 페이지가 정상적으로 로드되는지 확인

- [ ] **정답 필드 확인** (가장 중요!)
  - 분석 폼 페이지 접속
  - 정답 필드가 `<div>`로 표시되는지 확인 (입력 불가능해야 함)
  - 브라우저 개발자 도구 → Elements에서 확인:
    ```html
    <div class="w-full px-2 py-1.5 bg-gray-100...">
      {정답 번호}
    </div>
    ```
  - `<select>` 요소가 없어야 함

- [ ] **학생 답안 입력 확인**
  - 학생 답안 필드에 1-4 숫자만 입력 가능한지 확인

- [ ] **AI 분석 기능 테스트**
  - 분석 페이지에서 AI 보고서 생성 시도
  - 정상 작동 또는 적절한 에러 메시지 표시 확인

### ✅ **코드 검증 (고급)**

- [ ] **배포된 JavaScript 확인**
  - 브라우저 개발자 도구 → Sources → `_next/static/chunks`
  - `AnalysisForm` 관련 파일 검색
  - 정답 필드가 `<div>`로 구현되어 있는지 확인
  - `Ctrl+Shift+F`로 "select" 검색하여 `<select>` 요소가 없는지 확인

- [ ] **API 엔드포인트 확인**
  - 브라우저 개발자 도구 → Network
  - `/api/analyze` 요청 확인
  - 요청이 발생하는지, 응답 코드는 무엇인지 확인

---

## 7. 예상 시나리오별 해결 방법

### 시나리오 1: 정답 필드가 여전히 입력 가능함

**원인**: 구버전 코드가 배포됨

**해결**:
1. Vercel에서 Git 저장소가 `ssssanghyun/mega_viet`인지 확인
2. 최신 커밋 해시 확인 (`a50bcc6` 또는 그 이후)
3. Root Directory가 `web`인지 확인
4. 캐시 무시하고 재배포

### 시나리오 2: AI 분석이 작동하지 않음

**원인**: 환경 변수 미설정

**해결**:
1. Vercel 대시보드 → Environment Variables
2. `OPENAI_API_KEY` 추가
3. 모든 환경(Production, Preview, Development)에 적용
4. 재배포 (환경 변수 변경 시 자동 재배포됨)

### 시나리오 3: 빌드 실패

**원인**: Root Directory 설정 오류

**해결**:
1. Vercel 대시보드 → Settings → General
2. Root Directory를 `web`으로 설정
3. Save
4. 재배포

---

## 8. 최종 권장 사항

### 즉시 실행할 작업 (우선순위 순)

1. **Vercel 저장소 연결 확인** (가장 중요!)
   - `ssssanghyun/mega_viet` 저장소에 연결되어 있는지 확인
   - 최신 커밋(`a50bcc6`)이 배포되었는지 확인

2. **Root Directory 확인**
   - Vercel 대시보드에서 `web`으로 설정

3. **캐시 무시하고 재배포**
   - "Use existing Build Cache" 옵션 해제

4. **환경 변수 설정**
   - `OPENAI_API_KEY` 추가

5. **배포 후 검증**
   - 정답 필드가 read-only인지 확인
   - 브라우저 개발자 도구에서 실제 배포된 코드 확인

### 장기적 개선 사항

1. **CI/CD 파이프라인 구축**
   - GitHub Actions로 배포 전 빌드 검증

2. **배포 자동화 스크립트**
   - 배포 전 체크리스트 자동 실행

3. **모니터링 도구 연동**
   - Vercel Analytics
   - 에러 추적 (Sentry 등)

---

## 9. 결론

**가장 가능성이 높은 원인**: 
Vercel이 **잘못된 Git 저장소**를 배포하고 있거나, **Root Directory 설정**이 잘못되어 있습니다.

**즉시 확인할 사항**:
1. Vercel 대시보드 → Settings → Git → Repository 확인
2. Settings → General → Root Directory 확인 (`web`이어야 함)
3. 최신 커밋 해시 확인 (로컬 `a50bcc6`과 일치해야 함)

**예상 해결 시간**: 5-10분 (Vercel 설정 확인 및 재배포)

---

**문서 버전**: 1.0  
**최종 업데이트**: 2024년 12월

